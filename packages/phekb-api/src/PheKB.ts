let staticList = [
  {
    nid: "1506",
    vid: "3586",
    type: "phenotype",
    language: "und",
    title: "Type 1 and type 2 Diabetes Mellitus",
    uid: "15149",
    status: "1",
    created: "1596674145",
    changed: "1596751985",
    comment: "2",
    promote: "0",
    sticky: "0",
    tnid: "0",
    translate: "0",
    uri: "https://dev-phekb.pantheonsite.io/api/node/1506",
  },
  {
    nid: "1454",
    vid: "3539",
    type: "phenotype",
    language: "und",
    title: "Familial Hypercholesterolemia (NLP)",
    uid: "14941",
    status: "1",
    created: "1586403252",
    changed: "1590253686",
    comment: "2",
    promote: "0",
    sticky: "0",
    tnid: "0",
    translate: "0",
    uri: "https://dev-phekb.pantheonsite.io/api/node/1454",
  },
  {
    nid: "1451",
    vid: "3502",
    type: "phenotype",
    language: "und",
    title: "COVID-19 Counts for eMERGE",
    uid: "15059",
    status: "1",
    created: "1585685239",
    changed: "1586453756",
    comment: "2",
    promote: "0",
    sticky: "0",
    tnid: "0",
    translate: "0",
    uri: "https://dev-phekb.pantheonsite.io/api/node/1451",
  },
  {
    nid: "1431",
    vid: "3463",
    type: "phenotype",
    language: "und",
    title: "Obsessive-compulsive disorder",
    uid: "14523",
    status: "1",
    created: "1583602776",
    changed: "1583602776",
    comment: "2",
    promote: "0",
    sticky: "0",
    tnid: "0",
    translate: "0",
    uri: "https://dev-phekb.pantheonsite.io/api/node/1431",
  },
  {
    nid: "1429",
    vid: "3457",
    type: "phenotype",
    language: "und",
    title: "elll ICD/CPT Files Refresh for eMERGESeq",
    uid: "14932",
    status: "1",
    created: "1582732961",
    changed: "1582737975",
    comment: "2",
    promote: "0",
    sticky: "0",
    tnid: "0",
    translate: "0",
    uri: "https://dev-phekb.pantheonsite.io/api/node/1429",
  },
  {
    nid: "1417",
    vid: "3512",
    type: "phenotype",
    language: "und",
    title: "ACO (Asthma COPD Overlap)",
    uid: "14464",
    status: "1",
    created: "1581435187",
    changed: "1587414815",
    comment: "2",
    promote: "0",
    sticky: "0",
    tnid: "0",
    translate: "0",
    uri: "https://dev-phekb.pantheonsite.io/api/node/1417",
  },
  {
    nid: "1404",
    vid: "3468",
    type: "phenotype",
    language: "und",
    title: "Urinary Incontinence",
    uid: "15022",
    status: "1",
    created: "1579148917",
    changed: "1583776371",
    comment: "2",
    promote: "0",
    sticky: "0",
    tnid: "0",
    translate: "0",
    uri: "https://dev-phekb.pantheonsite.io/api/node/1404",
  },
  {
    nid: "1394",
    vid: "3547",
    type: "phenotype",
    language: "und",
    title:
      "ECG Traits Extracted from Electrocardiograms using Natural Language Processing",
    uid: "15101",
    status: "1",
    created: "1576613506",
    changed: "1590768222",
    comment: "2",
    promote: "0",
    sticky: "0",
    tnid: "0",
    translate: "0",
    uri: "https://dev-phekb.pantheonsite.io/api/node/1394",
  },
  {
    nid: "1388",
    vid: "3376",
    type: "phenotype",
    language: "und",
    title: "GWAS ICD & Meds Files",
    uid: "14932",
    status: "1",
    created: "1575571091",
    changed: "1575571106",
    comment: "2",
    promote: "0",
    sticky: "0",
    tnid: "0",
    translate: "0",
    uri: "https://dev-phekb.pantheonsite.io/api/node/1388",
  },
  {
    nid: "1376",
    vid: "3361",
    type: "phenotype",
    language: "und",
    title: "Pascal Test",
    uid: "14954",
    status: "1",
    created: "1574206167",
    changed: "1574206167",
    comment: "2",
    promote: "0",
    sticky: "0",
    tnid: "0",
    translate: "0",
    uri: "https://dev-phekb.pantheonsite.io/api/node/1376",
  },
  {
    nid: "1295",
    vid: "3230",
    type: "phenotype",
    language: "und",
    title: "elll BMI file re-uploads for dbGaP submission",
    uid: "14932",
    status: "1",
    created: "1565721216",
    changed: "1566999496",
    comment: "2",
    promote: "0",
    sticky: "0",
    tnid: "0",
    translate: "0",
    uri: "https://dev-phekb.pantheonsite.io/api/node/1295",
  },
  {
    nid: "1252",
    vid: "3172",
    type: "phenotype",
    language: "und",
    title: "eMERGE Phenotyping III case/control files collection",
    uid: "14932",
    status: "1",
    created: "1561554121",
    changed: "1561988992",
    comment: "2",
    promote: "0",
    sticky: "0",
    tnid: "0",
    translate: "0",
    uri: "https://dev-phekb.pantheonsite.io/api/node/1252",
  },
  {
    nid: "1205",
    vid: "3310",
    type: "phenotype",
    language: "und",
    title: "Digital Rectal Exam",
    uid: "14731",
    status: "1",
    created: "1557773569",
    changed: "1570722034",
    comment: "2",
    promote: "0",
    sticky: "0",
    tnid: "0",
    translate: "0",
    uri: "https://dev-phekb.pantheonsite.io/api/node/1205",
  },
  {
    nid: "1197",
    vid: "3079",
    type: "phenotype",
    language: "und",
    title: "bone scan utilization ",
    uid: "14731",
    status: "1",
    created: "1556237435",
    changed: "1556237598",
    comment: "2",
    promote: "0",
    sticky: "0",
    tnid: "0",
    translate: "0",
    uri: "https://dev-phekb.pantheonsite.io/api/node/1197",
  },
  {
    nid: "1196",
    vid: "3077",
    type: "phenotype",
    language: "und",
    title: "bone scan utilization ",
    uid: "14731",
    status: "1",
    created: "1556237268",
    changed: "1556237268",
    comment: "2",
    promote: "0",
    sticky: "0",
    tnid: "0",
    translate: "0",
    uri: "https://dev-phekb.pantheonsite.io/api/node/1196",
  },
  {
    nid: "1175",
    vid: "3225",
    type: "phenotype",
    language: "und",
    title: "Chronic Obstructive Lung Disease (COPD)",
    uid: "14464",
    status: "1",
    created: "1549485381",
    changed: "1566334997",
    comment: "2",
    promote: "0",
    sticky: "0",
    tnid: "0",
    translate: "0",
    uri: "https://dev-phekb.pantheonsite.io/api/node/1175",
  },
  {
    nid: "1149",
    vid: "3005",
    type: "phenotype",
    language: "und",
    title: "eMERGE III Record Counter, Y4U2, Winter 2019",
    uid: "14279",
    status: "1",
    created: "1547223552",
    changed: "1547230514",
    comment: "2",
    promote: "0",
    sticky: "0",
    tnid: "0",
    translate: "0",
    uri: "https://dev-phekb.pantheonsite.io/api/node/1149",
  },
  {
    nid: "1130",
    vid: "3474",
    type: "phenotype",
    language: "und",
    title: "Atopic Dermatitis Algorithm with NLP and ML",
    uid: "49",
    status: "1",
    created: "1542416063",
    changed: "1584479652",
    comment: "2",
    promote: "0",
    sticky: "0",
    tnid: "0",
    translate: "0",
    uri: "https://dev-phekb.pantheonsite.io/api/node/1130",
  },
  {
    nid: "1105",
    vid: "3332",
    type: "phenotype",
    language: "und",
    title: "Anxiety algorithm",
    uid: "4077",
    status: "1",
    created: "1540386714",
    changed: "1572618770",
    comment: "2",
    promote: "0",
    sticky: "0",
    tnid: "0",
    translate: "0",
    uri: "https://dev-phekb.pantheonsite.io/api/node/1105",
  },
  {
    nid: "1100",
    vid: "2921",
    type: "phenotype",
    language: "und",
    title:
      "eMERGE I, II, III Merged Imputed GWAS Dataset: Subject Consent for dbGaP",
    uid: "14279",
    status: "1",
    created: "1539006260",
    changed: "1539782744",
    comment: "2",
    promote: "0",
    sticky: "0",
    tnid: "0",
    translate: "0",
    uri: "https://dev-phekb.pantheonsite.io/api/node/1100",
  },
];

class PheKB {
  baseUrl: string;

  constructor(baseUrl: string) {
    this.baseUrl = baseUrl;
  }

  sortByName(phenotypes) {
    return phenotypes.sort((a, b) =>
      a.title.toUpperCase() < b.title.toUpperCase() ? -1 : 1
    );
  }

  async getPhenotypeById(id) {
    return new Promise((resolve, reject) => {

      return fetch(`${this.baseUrl}/node/${id}`).then((res) => {
        if (res.status !== 200) {
          reject(res.statusText);
        }

        return resolve(res.json())
      });
    });
  }

  async getPhenotype(uri) {
    return await fetch(`https://cors.phema.science:4321/${uri}`).then((res) =>
      res.json()
    );
  }

  async getPhenotypes(maxPages) {
    // Use the following for testing so we don't keep hitting the server
    // return Promise.resolve(this.sortByName(staticList));

    // Stub for testing
    // const phenotypes = [{ "nid": "78", "vid": "1922", "type": "phenotype", "language": "und", "title": "Atrial Fibrillation - Demonstration Project", "uid": "33", "status": "1", "created": "1453218527", "changed": "1487364037", "comment": "2", "promote": "1", "sticky": "0", "tnid": "0", "translate": "0", "uri": "https://dev-phekb.pantheonsite.io/api/node/78" }, { "nid": "84", "vid": "1911", "type": "phenotype", "language": "und", "title": "Methotrexate liver injury", "uid": "30", "status": "1", "created": "1453218527", "changed": "1487364033", "comment": "2", "promote": "0", "sticky": "0", "tnid": "0", "translate": "0", "uri": "https://dev-phekb.pantheonsite.io/api/node/84" }, { "nid": "88", "vid": "1390", "type": "phenotype", "language": "und", "title": "Clopidogrel Poor Metabolizers", "uid": "14471", "status": "1", "created": "1453218527", "changed": "1453218527", "comment": "2", "promote": "1", "sticky": "0", "tnid": "0", "translate": "0", "uri": "https://dev-phekb.pantheonsite.io/api/node/88" }, { "nid": "90", "vid": "1923", "type": "phenotype", "language": "und", "title": "ACE Inhibitor (ACE-I) induced cough", "uid": "30", "status": "1", "created": "1453218527", "changed": "1487364037", "comment": "2", "promote": "0", "sticky": "0", "tnid": "0", "translate": "0", "uri": "https://dev-phekb.pantheonsite.io/api/node/90" }, { "nid": "92", "vid": "2962", "type": "phenotype", "language": "und", "title": "Diverticulosis and Diverticulitis", "uid": "0", "status": "1", "created": "1453218527", "changed": "1542415099", "comment": "2", "promote": "1", "sticky": "0", "tnid": "0", "translate": "0", "uri": "https://dev-phekb.pantheonsite.io/api/node/92" }, { "nid": "93", "vid": "2773", "type": "phenotype", "language": "und", "title": "Colon Polyps", "uid": "49", "status": "1", "created": "1453218527", "changed": "1530026378", "comment": "2", "promote": "1", "sticky": "0", "tnid": "0", "translate": "0", "uri": "https://dev-phekb.pantheonsite.io/api/node/93" }, { "nid": "97", "vid": "1331", "type": "phenotype", "language": "und", "title": "Abdominal Aortic Aneurysm ( AAA )", "uid": "14471", "status": "1", "created": "1453218527", "changed": "1453218527", "comment": "2", "promote": "0", "sticky": "0", "tnid": "0", "translate": "0", "uri": "https://dev-phekb.pantheonsite.io/api/node/97" }, { "nid": "99", "vid": "1131", "type": "phenotype", "language": "und", "title": "Ocular Hypertension", "uid": "14471", "status": "1", "created": "1453218527", "changed": "1453218527", "comment": "2", "promote": "1", "sticky": "0", "tnid": "0", "translate": "0", "uri": "https://dev-phekb.pantheonsite.io/api/node/99" }, { "nid": "100", "vid": "1132", "type": "phenotype", "language": "und", "title": "Glaucoma", "uid": "14471", "status": "1", "created": "1453218527", "changed": "1453218527", "comment": "2", "promote": "1", "sticky": "0", "tnid": "0", "translate": "0", "uri": "https://dev-phekb.pantheonsite.io/api/node/100" }, { "nid": "104", "vid": "253", "type": "phenotype", "language": "und", "title": "Vancomycin Trough, Ke, and Delta Creatinine", "uid": "14471", "status": "1", "created": "1453218527", "changed": "1453218527", "comment": "2", "promote": "1", "sticky": "0", "tnid": "0", "translate": "0", "uri": "https://dev-phekb.pantheonsite.io/api/node/104" }, { "nid": "109", "vid": "1994", "type": "phenotype", "language": "und", "title": "Venous Thromboembolism (VTE)", "uid": "63", "status": "1", "created": "1453218527", "changed": "1490742107", "comment": "2", "promote": "1", "sticky": "0", "tnid": "0", "translate": "0", "uri": "https://dev-phekb.pantheonsite.io/api/node/109" }, { "nid": "112", "vid": "1245", "type": "phenotype", "language": "und", "title": "Herpes Zoster", "uid": "14471", "status": "1", "created": "1453218527", "changed": "1453218527", "comment": "2", "promote": "0", "sticky": "0", "tnid": "0", "translate": "0", "uri": "https://dev-phekb.pantheonsite.io/api/node/112" }, { "nid": "113", "vid": "1395", "type": "phenotype", "language": "und", "title": "CES1 and Clopidogrel Responsiveness/Bleeding", "uid": "14471", "status": "1", "created": "1453218527", "changed": "1453218527", "comment": "2", "promote": "0", "sticky": "0", "tnid": "0", "translate": "0", "uri": "https://dev-phekb.pantheonsite.io/api/node/113" }, { "nid": "114", "vid": "1399", "type": "phenotype", "language": "und", "title": "Pharmacogenomics of Statin Effects in Asthma", "uid": "14471", "status": "1", "created": "1453218527", "changed": "1453218527", "comment": "2", "promote": "0", "sticky": "0", "tnid": "0", "translate": "0", "uri": "https://dev-phekb.pantheonsite.io/api/node/114" }, { "nid": "115", "vid": "2816", "type": "phenotype", "language": "und", "title": "Asthma Response to Inhaled Steroids", "uid": "0", "status": "1", "created": "1453218527", "changed": "1530287344", "comment": "2", "promote": "0", "sticky": "0", "tnid": "0", "translate": "0", "uri": "https://dev-phekb.pantheonsite.io/api/node/115" }, { "nid": "116", "vid": "1402", "type": "phenotype", "language": "und", "title": "Statin Dose Response", "uid": "14471", "status": "1", "created": "1453218527", "changed": "1453218527", "comment": "2", "promote": "0", "sticky": "0", "tnid": "0", "translate": "0", "uri": "https://dev-phekb.pantheonsite.io/api/node/116" }, { "nid": "117", "vid": "1086", "type": "phenotype", "language": "und", "title": "Statins and MI", "uid": "14471", "status": "1", "created": "1453218527", "changed": "1453218527", "comment": "2", "promote": "0", "sticky": "0", "tnid": "0", "translate": "0", "uri": "https://dev-phekb.pantheonsite.io/api/node/117" }, { "nid": "118", "vid": "311", "type": "phenotype", "language": "und", "title": "Onychomycosis", "uid": "14471", "status": "1", "created": "1453218527", "changed": "1453218527", "comment": "2", "promote": "0", "sticky": "0", "tnid": "0", "translate": "0", "uri": "https://dev-phekb.pantheonsite.io/api/node/118" }, { "nid": "119", "vid": "312", "type": "phenotype", "language": "und", "title": "Keratosis and Carcinoma", "uid": "14471", "status": "1", "created": "1453218527", "changed": "1453218527", "comment": "2", "promote": "0", "sticky": "0", "tnid": "0", "translate": "0", "uri": "https://dev-phekb.pantheonsite.io/api/node/119" }, { "nid": "120", "vid": "1114", "type": "phenotype", "language": "und", "title": "Diabetes/Hypertension-Associated Chronic Kidney Disease", "uid": "14471", "status": "1", "created": "1453218527", "changed": "1453218527", "comment": "2", "promote": "0", "sticky": "0", "tnid": "0", "translate": "0", "uri": "https://dev-phekb.pantheonsite.io/api/node/120" }];

    const phenotypes = [];

    const pageLimit = maxPages || 1000;

    let page = 0;

    let results;
    do {
      results = await fetch(
        `${this.baseUrl}/node?parameters[type]=phenotype&options[sort]=nid&page=${page}`
      )
        .then(async (res) => {
          if (res.status != 200) {
            return Promise.reject(`${res.status}: ${await res.text()}`);
          }

          return res.json();
        })
        .catch((err) => {
          return Promise.reject(err);
        });

      if (results.length > 0) {
        phenotypes.push(...results);
        page++;
      }
    } while (results.length > 0 && page < pageLimit);

    return this.sortByName(phenotypes);
  }
}

export default PheKB;
